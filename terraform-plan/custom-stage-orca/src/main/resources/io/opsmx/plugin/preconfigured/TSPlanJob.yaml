label: TSPlanJob
cloudProvider: kubernetes
application: opsmx
description: Stage for terraspin plan operation
account: default
type: customTSPlanJobStage
waitForCompletion: true
parameters:
  - defaultValue: ''
    description: >-
      Please enter the artifact account name from artifactsaccounts.json,
      Account where you have tf script present.
    label: Tf script account
    mapping: 'manifest.spec.template.spec.containers[0].env[0].value'
    name: scriptaccount
  - defaultValue: ''
    description: Please enter the Git Repo Account of TF script.
    label: Tf Plan script Repo
    mapping: 'manifest.spec.template.spec.containers[0].env[1].value'
    name: repo
  - defaultValue: ''
    description: Please enter Location of terraform script in the repo.
    label: Tf Location
    mapping: 'manifest.spec.template.spec.containers[0].env[2].value'
    name: location
  - defaultValue: ''
    description: Please enter overrideVariableFile path if you want to override variables.
    label: Override file
    mapping: 'manifest.spec.template.spec.containers[0].env[3].value'
    name: overridefile
  - defaultValue: ''
    description: Please enter the artifact account where you want to save tf state.
    label: Tf State Account
    mapping: 'manifest.spec.template.spec.containers[0].env[4].value'
    name: stateaccount
  - defaultValue: ''
    description: >-
      Please enter the location  where you want to save terraform intermediate
      state like gitrepo, s3bucket.
    label: Artifact Repo
    mapping: 'manifest.spec.template.spec.containers[0].env[5].value'
    name: staterepo
  - defaultValue: ''
    description: Please enter a unique artifactid to identify the terraform state.
    label: Artifact UUId
    mapping: 'manifest.spec.template.spec.containers[0].env[6].value'
    name: artifactid
manifest:
  apiVersion: batch/v1
  kind: Job
  metadata:
    generateName: terraspinplanjob-
    namespace: spinterra
  spec:
    backoffLimit: 0
    template:
      spec:
        containers:
          - command:
              - run.sh
            env:
              - name: scriptaccount
                value: "$(scriptaccount)"
              - name: repo
                value: "$(repo)"
              - name: location
                value: "$(location)"
              - name: overridefile
                value: "$(overridefile)"
              - name: stateaccount
                value: "$(stateaccount)"
              - name: staterepo
                value: "$(staterepo)"
              - name: artifactid
                value: "$(artifactid)"
              - name: command
                value: plan
            image: 'quay.io/opsmxpublic/customterraformstage:v1'
            imagePullPolicy: Always
            name: terraspinplan
            volumeMounts:
              - mountPath: /home/terraspin/opsmx/app/config/
                name: opsmx-terraspin-backend-config
        restartPolicy: Never
        volumes:
          - secret:
              secretName: terraspinbackendconfig
            name: opsmx-terraspin-backend-config
